import streamlit as st
import os
from openai import OpenAI
from dotenv import load_dotenv

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="PBL-Simulator ü§ñ",
    page_icon="üéì",
    layout="wide"
)

# –ó–∞–≥—Ä—É–∂–∞–µ–º API –∫–ª—é—á
load_dotenv()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–µ–Ω—Ç–∞
@st.cache_resource
def get_ai_client():
    return OpenAI(
        api_key=os.getenv("DEEPSEEK_API_KEY"),
        base_url="https://api.deepseek.com"
    )

client = get_ai_client()

# –ü—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ä–æ–ª–∏
PRESET_ROLES = {
    "CEO –∫–æ–º–ø–∞–Ω–∏–∏": {
        "description": "–ì–µ–Ω–µ—Ä–∞–ª—å–Ω—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä, –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –ø—Ä–∏–±—ã–ª—å",
        "system_prompt": """–¢—ã CEO —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∫–æ–º–ø–∞–Ω–∏–∏. –¢–≤–æ–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:
        1. –ü—Ä–∏–±—ã–ª—å –∏ —Ä–æ—Å—Ç –∞–∫—Ü–∏–æ–Ω–µ—Ä–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏
        2. –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏ —Å–∫–æ—Ä–æ—Å—Ç—å
        3. –ú–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Ä–∏—Å–∫–æ–≤
        4. –ö–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ
        
        –¢—ã –≤—Å—Ç—Ä–µ—á–∞–µ—à—å—Å—è —Å–æ —Å—Ç–∞—Ä—Ç–∞–ø–æ–º/—Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏. –ë—É–¥—å —Å–∫–µ–ø—Ç–∏—á–Ω—ã–º.
        –í—Å–µ–≥–¥–∞ —Å–ø—Ä–∞—à–∏–≤–∞–π: "–ö–∞–∫–æ–≤ ROI?", "–ö–∞–∫–∏–µ —Ä–∏—Å–∫–∏?", "–ü–æ—á–µ–º—É —ç—Ç–æ –ª—É—á—à–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ä–µ—à–µ–Ω–∏–π?"
        –ì–æ–≤–æ—Ä–∏ –∫—Ä–∞—Ç–∫–æ –∏ –¥–µ–ª–æ–≤–∏—Ç–æ."""
    },
    "–ò–Ω–∂–µ–Ω–µ—Ä-—Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫": {
        "description": "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç, —Å—Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏",
        "system_prompt": """–¢—ã senior –∏–Ω–∂–µ–Ω–µ—Ä —Å 10-–ª–µ—Ç–Ω–∏–º –æ–ø—ã—Ç–æ–º. –¢–≤–æ–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:
        1. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑—É–µ–º–æ—Å—Ç—å
        2. –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã
        3. –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞
        4. –°—Ä–æ–∫–∏ –∏ –æ—Ü–µ–Ω–∫–∏
        
        –¢—ã —Å–∫–µ–ø—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–Ω–æ—Å–∏—à—å—Å—è –∫ –Ω–µ–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–º –æ–±–µ—â–∞–Ω–∏—è–º.
        –°–ø—Ä–∞—à–∏–≤–∞–π –æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª—è—Ö: —Å—Ç–µ–∫ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, API.
        –£–∫–∞–∑—ã–≤–∞–π –Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã."""
    },
    "–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å —Å–æ–æ–±—â–µ—Å—Ç–≤–∞": {
        "description": "–ê–∫—Ç–∏–≤–∏—Å—Ç, –∑–∞—â–∏—â–∞—é—â–∏–π –∏–Ω—Ç–µ—Ä–µ—Å—ã –∂–∏—Ç–µ–ª–µ–π",
        "system_prompt": """–¢—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å –º–µ—Å—Ç–Ω–æ–≥–æ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞. –¢–≤–æ–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã:
        1. –≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
        2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –∂–∏–∑–Ω–∏
        3. –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏ —É—á–∞—Å—Ç–∏–µ –∂–∏—Ç–µ–ª–µ–π
        4. –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è
        
        –¢—ã –Ω–µ –¥–æ–≤–µ—Ä—è–µ—à—å –±–æ–ª—å—à–∏–º –∫–æ—Ä–ø–æ—Ä–∞—Ü–∏—è–º.
        –°–ø—Ä–∞—à–∏–≤–∞–π –æ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–∏ –Ω–∞ —Å—Ä–µ–¥—É, —à—É–º–µ, —Ç—Ä–∞—Ñ–∏–∫–µ.
        –¢—Ä–µ–±—É–π –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —Å–ª—É—à–∞–Ω–∏–π –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π."""
    }
}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–∞—Ç–∞
if "messages" not in st.session_state:
    st.session_state.messages = []
if "current_role" not in st.session_state:
    st.session_state.current_role = "CEO –∫–æ–º–ø–∞–Ω–∏–∏"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç AI
def get_ai_response(messages, system_prompt):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ DeepSeek API"""
    try:
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç
        full_messages = [{"role": "system", "content": system_prompt}] + messages
        
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=full_messages,
            temperature=0.7,
            max_tokens=500
        )
        
        return response.choices[0].message.content
        
    except Exception as e:
        return f"‚ùå –û—à–∏–±–∫–∞ API: {str(e)}"

# –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
st.title("üéì PBL-Simulator: –¢—Ä–µ–Ω–∞–∂–µ—Ä –¥–ª—è –ø—Ä–æ–µ–∫—Ç–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è")
st.markdown("üí° **–û–±—â–∞–π—Å—è —Å AI-–∞–≥–µ–Ω—Ç–∞–º–∏, –∏–≥—Ä–∞—é—â–∏–º–∏ —Ä–æ–ª–∏ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω**")

# –°–∞–π–¥–±–∞—Ä –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏
with st.sidebar:
    st.header("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≥–µ–Ω—Ç–∞")
    
    # –í—ã–±–æ—Ä —Ä–æ–ª–∏
    selected_role = st.selectbox(
        "–í—ã–±–µ—Ä–∏ —Ä–æ–ª—å –∞–≥–µ–Ω—Ç–∞:",
        list(PRESET_ROLES.keys()),
        index=list(PRESET_ROLES.keys()).index(st.session_state.current_role)
    )
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–æ–ª—å –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
    if selected_role != st.session_state.current_role:
        st.session_state.current_role = selected_role
        st.session_state.messages = []  # –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
        st.rerun()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ —Ä–æ–ª–∏
    role_info = PRESET_ROLES[selected_role]
    st.markdown(f"**–û–ø–∏—Å–∞–Ω–∏–µ:** {role_info['description']}")
    
    # –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –¥–∏–∞–ª–æ–≥–∞
    if st.button("üîÑ –ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π –¥–∏–∞–ª–æ–≥", use_container_width=True):
        st.session_state.messages = []
        st.rerun()
    
    st.divider()
    
    # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    st.markdown("### üìã –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:")
    st.markdown("""
    1. –í—ã–±–µ—Ä–∏ —Ä–æ–ª—å –∞–≥–µ–Ω—Ç–∞ —Å–ª–µ–≤–∞
    2. –ù–∞—á–Ω–∏ –¥–∏–∞–ª–æ–≥ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –æ–∫–Ω–µ
    3. –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–π –∏–¥–µ–∏
    4. –ü–æ–ª—É—á–∞–π —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –æ—Ç –∞–≥–µ–Ω—Ç–∞
    5. –ü—Ä–∞–∫—Ç–∏–∫—É–π –Ω–∞–≤—ã–∫–∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏!
    """)
    
    # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
    st.divider()
    st.markdown("### ‚ÑπÔ∏è –û –ø—Ä–æ–µ–∫—Ç–µ")
    st.markdown("–≠—Ç–æ –ø—Ä–æ—Ç–æ—Ç–∏–ø —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ –¥–ª—è **–ø—Ä–æ–µ–∫—Ç–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è (PBL)**.")
    st.markdown("–ê–≥–µ–Ω—Ç—ã –∏–º–∏—Ç–∏—Ä—É—é—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã—Ö —Å—Ç–æ—Ä–æ–Ω.")

# –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞
st.subheader(f"ü§ñ –î–∏–∞–ª–æ–≥ —Å: **{st.session_state.current_role}**")

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
chat_container = st.container()
with chat_container:
    for message in st.session_state.messages:
        avatar = "üë§" if message["role"] == "user" else "ü§ñ"
        with st.chat_message(message["role"], avatar=avatar):
            st.markdown(message["content"])

# –ü–æ–ª–µ –≤–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
if prompt := st.chat_input("–ù–∞–ø–∏—à–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–≥–µ–Ω—Ç—É..."):
    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    st.session_state.messages.append({"role": "user", "content": prompt})
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    with chat_container:
        with st.chat_message("user", avatar="üë§"):
            st.markdown(prompt)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    with st.spinner("ü§ñ –ê–≥–µ–Ω—Ç –¥—É–º–∞–µ—Ç..."):
        # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç AI
        system_prompt = PRESET_ROLES[st.session_state.current_role]["system_prompt"]
        ai_response = get_ai_response(st.session_state.messages, system_prompt)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç AI
    st.session_state.messages.append({"role": "assistant", "content": ai_response})
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Ç–≤–µ—Ç AI
    with chat_container:
        with st.chat_message("assistant", avatar="ü§ñ"):
            st.markdown(ai_response)

# –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
if len(st.session_state.messages) == 0:
    st.info("üí° **–ù–∞—á–Ω–∏ –¥–∏–∞–ª–æ–≥!** –ù–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–µ–¥—Å—Ç–∞–≤—å —Å–≤–æ–π –ø—Ä–æ–µ–∫—Ç –∏–ª–∏ –∑–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –∞–≥–µ–Ω—Ç—É.")

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–∫–µ–Ω–∞—Ö (–ø—Ä–∏–º–µ—Ä–Ω–∞—è)
if st.session_state.messages:
    st.caption(f"üìä –°–æ–æ–±—â–µ–Ω–∏–π –≤ –¥–∏–∞–ª–æ–≥–µ: {len(st.session_state.messages)}")